–û–±—â–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ (–æ—á–µ–Ω—å –≤–∞–∂–Ω–æ –ø–æ–Ω—è—Ç—å)

–£ —Ç–µ–±—è multi-tenancy:

Central DB
–•—Ä–∞–Ω–∏—Ç:

users

companies

company_user

permissions

tenants

Tenant DB (–æ—Ç–¥–µ–ª—å–Ω–∞—è –ë–î –Ω–∞ –∫–æ–º–ø–∞–Ω–∏—é)
–•—Ä–∞–Ω–∏—Ç:

chats

chat_participants

orders

–∏ –¥—Ä—É–≥–∏–µ –±–∏–∑–Ω–µ—Å-—Ç–∞–±–ª–∏—Ü—ã

üëâ Broadcast channels –í–°–ï–ì–î–ê —Å—Ç–∞—Ä—Ç—É—é—Ç –∏–∑ central DB,
–∏ —Ç—ã –≤—Ä—É—á–Ω—É—é –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—à—å—Å—è –Ω–∞ tenant DB, –∫–æ–≥–¥–∞ –Ω–∞–¥–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —á–∞—Ç–∞/–∑–∞–∫–∞–∑–æ–≤.

1Ô∏è‚É£ App.Models.User.{id}
Broadcast::channel('App.Models.User.{id}', function ($user, $id) {
    return (int) $user->id === (int) $id;
});

–ß—Ç–æ –¥–µ–ª–∞–µ—Ç

–≠—Ç–æ private channel

–†–∞–∑—Ä–µ—à–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–ª—É—à–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–∞–Ω–∞–ª

üìå –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:

notifications

–ª–∏—á–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π

—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Laravel –∫–∞–Ω–∞–ª

üß† –†–∞–±–æ—Ç–∞–µ—Ç –¢–û–õ–¨–ö–û –≤ central DB
(–Ω–∏–∫–∞–∫–æ–≥–æ tenancy —Ç—É—Ç –Ω–µ –Ω—É–∂–Ω–æ)

2Ô∏è‚É£ ensureTenancyForBroadcastChannel()
function ensureTenancyForBroadcastChannel(int $companyId): void

–≠—Ç–æ –∫–ª—é—á–µ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è üîë

–ß—Ç–æ –æ–Ω–∞ –¥–µ–ª–∞–µ—Ç:

–ò—â–µ—Ç –∫–æ–º–ø–∞–Ω–∏—é –≤ central DB

–ë–µ—Ä—ë—Ç tenant_id

–ù–∞—Ö–æ–¥–∏—Ç tenant –≤ central DB

–í—ã–∑—ã–≤–∞–µ—Ç:

tenancy()->initialize($tenant);


üí• –° —ç—Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞ –≤—Å–µ DB::table() –±—É–¥—É—Ç –∏–¥—Ç–∏ –≤ tenant DB

‚ö†Ô∏è –û—á–µ–Ω—å –≤–∞–∂–Ω–æ:

–î–æ –≤—ã–∑–æ–≤–∞ ‚Üí central DB

–ü–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞ ‚Üí tenant DB

–¢—ã –∏—Å–ø–æ–ª—å–∑—É–µ—à—å —ç—Ç–æ –¢–û–õ–¨–ö–û —Ç–∞–º, –≥–¥–µ —Ä–µ–∞–ª—å–Ω–æ –Ω—É–∂–Ω—ã tenant-—Ç–∞–±–ª–∏—Ü—ã

3Ô∏è‚É£ company.{companyId}.chat.{chatId}
Broadcast::channel('company.{companyId}.chat.{chatId}', function ($user, $companyId, $chatId) {

–õ–æ–≥–∏–∫–∞ –ø–æ —à–∞–≥–∞–º
üü¶ –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ –∫ –∫–æ–º–ø–∞–Ω–∏–∏ (central DB)
DB::connection($central)->table('company_user')->exists()


‚úî –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–≤—è–∑–∞–Ω —Å –∫–æ–º–ø–∞–Ω–∏–µ–π
‚ùå –ò–Ω–∞—á–µ ‚Äî –æ—Ç–∫–∞–∑

üü¶ –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ (central DB)
$user->getAllPermissionsForCompany($companyId)


–ï—Å–ª–∏:

–Ω–µ admin

–Ω–µ—Ç chats_view_all

‚ùå –¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω

üü¶ –®–∞–≥ 3: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ tenant DB
ensureTenancyForBroadcastChannel($companyId);


üí° –° —ç—Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞:

DB::table('chat_participants')

DB::table('chats')

üëâ –∏–¥—É—Ç –≤ tenant DB —ç—Ç–æ–π –∫–æ–º–ø–∞–Ω–∏–∏

üü¶ –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—á–∞—Å—Ç–∏—è –≤ —á–∞—Ç–µ (tenant DB)
DB::table('chat_participants')
    ->join('chats', ...)
    ->where(...)
    ->exists();


‚úî –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—á–∞—Å—Ç–Ω–∏–∫ —á–∞—Ç–∞
‚úî –ß–∞—Ç –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –∫–æ–º–ø–∞–Ω–∏–∏
‚úî –ß–∞—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

‚û°Ô∏è –ü–æ–¥–ø–∏—Å–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∞

4Ô∏è‚É£ company.{companyId}.orders
Broadcast::channel('company.{companyId}.orders', function ($user, $companyId) {

–ß—Ç–æ –≤–∞–∂–Ω–æ

–ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è tenancy()

–†–∞–±–æ—Ç–∞ –∏–¥—ë—Ç –¢–û–õ–¨–ö–û —Å central DB

–ü–æ—á–µ–º—É?

–¢—ã –ø—Ä–æ–≤–µ—Ä—è–µ—à—å –¢–û–õ–¨–ö–û –ø—Ä–∞–≤–∞

–°–∞–º–∏ –∑–∞–∫–∞–∑—ã, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Å–æ–±—ã—Ç–∏—è–º–∏, –Ω–æ –¥–æ—Å—Ç—É–ø –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ

‚úî Admin ‚Äî –≤—Å–µ–≥–¥–∞ –º–æ–∂–Ω–æ
‚úî –ò–Ω–∞—á–µ ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ permissions:

orders_view

orders_view_all

orders_simple_view

orders_simple_view_all

5Ô∏è‚É£ company.{companyId}.presence (Presence Channel)
Broadcast::channel('company.{companyId}.presence', function ($user, $companyId) {

–ß—Ç–æ –¥–µ–ª–∞–µ—Ç

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–≤—è–∑—å user ‚Üî company (central DB)

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–∞

–ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç tenant DB

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É–±–ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

return [
  'id', 'name', 'surname', 'email', 'photo'
];


üí° Presence-–∫–∞–Ω–∞–ª—ã:

–≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –º–∞—Å—Å–∏–≤ ‚Üí –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –æ–Ω–ª–∞–π–Ω–µ

false ‚Üí –¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω

üß† –ö–ª—é—á–µ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (–∫–æ—Ä–æ—Ç–∫–æ)
–≠—Ç–∞–ø	–ë–î
–ü—Ä–æ–≤–µ—Ä–∫–∞ user ‚Üî company	central
–ü—Ä–æ–≤–µ—Ä–∫–∞ permissions	central
–†–∞–±–æ—Ç–∞ —Å chat / participants	tenant
Presence / Orders –¥–æ—Å—Ç—É–ø	central
‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã (–æ–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ)
1Ô∏è‚É£ tenancy()->initialize() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é

‚úî –≠—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –¥–ª—è Broadcast

‚ùå –ù–æ tenancy –ù–ï —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

–õ—É—á—à–µ –ø–æ—Å–ª–µ tenant-–ª–æ–≥–∏–∫–∏ –¥–µ–ª–∞—Ç—å:

tenancy()->end();


(–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ)

2Ô∏è‚É£ Broadcast –≤—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –∏–∑ central DB

–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ
–¢—ã –æ—á–µ–Ω—å –≥—Ä–∞–º–æ—Ç–Ω–æ —Å–¥–µ–ª–∞–ª –ø–µ—Ä–µ—Ö–æ–¥

3Ô∏è‚É£ –û—à–∏–±–∫–∏ –Ω–µ –ª–æ–º–∞—é—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
catch (\Throwable $e) {
    report($e);
    return false;
}


üëç –û—Ç–ª–∏—á–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞

üî• –ò—Ç–æ–≥

‚úî –¢—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å central + tenant DB
‚úî –õ–æ–≥–∏–∫–∞ –∫–∞–Ω–∞–ª–æ–≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è
‚úî –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ tenancy —Å–¥–µ–ª–∞–Ω–æ –≤ –Ω—É–∂–Ω–æ–º –º–µ—Å—Ç–µ
‚úî –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –Ω–∞ —Ö–æ—Ä–æ—à–µ–º —É—Ä–æ–≤–Ω–µ

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äî –≤ —Å–ª–µ–¥—É—é—â–µ–º —à–∞–≥–µ –º–æ–∂–µ–º:

üîß –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å (–∫—ç—à permissions)

üßº –≤—ã–Ω–µ—Å—Ç–∏ –ª–æ–≥–∏–∫—É –≤ —Å–µ—Ä–≤–∏—Å—ã

üöÄ —Ä–∞–∑–æ–±—Ä–∞—Ç—å Echo / Reverb / Pusher

‚ö†Ô∏è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å edge-cases (race condition, reconnect)

–°–∫–∞–∂–∏, –∫—É–¥–∞ –ø–æ–π–¥—ë–º –¥–∞–ª—å—à–µ üëå
