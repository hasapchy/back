# План реализации Multi-Tenant с отдельными базами данных

## Цель
Переход от фильтрации по company_id к отдельным базам данных для каждой компании.

## Этапы реализации

### 1. Подготовка инфраструктуры
- [ ] Создать сервис для управления подключениями к базам данных (DatabaseConnectionService)
- [ ] Добавить поле `database_name` в таблицу `companies` (миграция)
- [ ] Создать middleware для автоматического переключения подключения к БД (SetTenantDatabaseMiddleware)
- [ ] Обновить конфигурацию database.php для поддержки динамических подключений

### 2. Создание и управление базами данных
- [ ] Создать команду artisan для создания новой базы данных для компании
- [ ] Создать команду artisan для удаления базы данных компании
- [ ] Обновить CompanySeeder для создания БД при создании компании
- [ ] Создать сервис для выполнения миграций в конкретной БД (MigrationService)

### 3. Обновление моделей
- [ ] Создать базовый трейт для моделей с автоматическим переключением подключения
- [ ] Обновить все модели для использования динамического подключения
- [ ] Убрать фильтры по company_id из всех моделей и запросов
- [ ] Обновить связи между моделями (убрать company_id из where условий)

### 4. Обновление репозиториев
- [ ] Убрать все методы с фильтрацией по company_id
- [ ] Убрать getCurrentCompanyId() из BaseRepository
- [ ] Обновить все запросы в репозиториях (убрать where('company_id', ...))
- [ ] Обновить кэширование (добавить database_name в ключи кэша)

### 5. Обновление контроллеров
- [ ] Убрать проверки и фильтры по company_id из контроллеров
- [ ] Обновить методы получения данных (убрать фильтры по компании)
- [ ] Обновить методы создания/обновления (убрать установку company_id)

### 6. Обновление миграций
- [ ] Убрать company_id из всех таблиц (кроме companies и связующих)
- [ ] Создать миграцию для удаления company_id из существующих таблиц
- [ ] Обновить внешние ключи и индексы
- [ ] Создать скрипт миграции данных (если нужно)

### 7. Обновление системы прав доступа
- [ ] Убрать company_id из таблицы roles
- [ ] Убрать company_user_role (роли теперь глобальные или через отдельные БД)
- [ ] Обновить систему пермишенов (убрать привязку к компании)
- [ ] Обновить PermissionWithScopeMiddleware

### 8. Обновление кэширования
- [ ] Обновить CacheService для работы с разными БД
- [ ] Добавить database_name в ключи кэша
- [ ] Обновить методы инвалидации кэша

### 9. Обновление сидеров
- [ ] Обновить все сидеры для работы без company_id
- [ ] Создать сидер для каждой новой БД компании
- [ ] Обновить RolesSeeder (роли теперь глобальные)
- [ ] Обновить AdminSeeder и SimpleWorkerSeeder

### 10. Тестирование
- [ ] Протестировать создание новой компании с БД
- [ ] Протестировать переключение между компаниями
- [ ] Протестировать все CRUD операции
- [ ] Протестировать права доступа
- [ ] Протестировать миграции для новых БД

### 11. Документация
- [ ] Обновить документацию по архитектуре
- [ ] Создать инструкцию по созданию новой компании
- [ ] Обновить README с информацией о multi-tenant

### 12. Миграция существующих данных (опционально)
- [ ] Создать скрипт для разделения данных по БД
- [ ] Создать резервные копии перед миграцией
- [ ] Выполнить миграцию данных
- [ ] Проверить целостность данных после миграции

## Важные моменты

### Главная база данных
- Должна содержать только таблицы: `companies`, `users`, `company_user` (связь пользователей с компаниями)
- Все остальные таблицы будут в БД каждой компании

### Подключение к БД
- По умолчанию используется главная БД
- При наличии X-Company-ID в заголовке переключается на БД компании
- Middleware автоматически переключает подключение

### Безопасность
- Проверка доступа пользователя к компании перед переключением БД
- Валидация существования БД компании
- Обработка ошибок подключения

## Порядок выполнения
1. Сначала создать инфраструктуру (п.1-2)
2. Затем обновить модели и репозитории (п.3-4)
3. Потом обновить контроллеры и миграции (п.5-6)
4. Обновить права доступа и кэширование (п.7-8)
5. Обновить сидеры (п.9)
6. Тестирование (п.10)
7. Документация (п.11)
8. Миграция данных (п.12) - только если есть существующие данные

