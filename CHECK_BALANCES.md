# Проверка и исправление балансов касс

## 🚀 Быстрый старт

```bash
# Проверить балансы всех касс
php artisan cash:balance check

# Анализировать расхождения
php artisan cash:balance analyze

# Исправить балансы (с подтверждением)
php artisan cash:balance fix
```

---

## 📋 Команда

```bash
php artisan cash:balance {действие} {касса?} {--опции}
```

### Действия:
- `check` - проверка балансов (по умолчанию)
- `analyze` - анализ расхождений
- `fix` - исправление балансов

### Опции:
- `--detailed` - детальная информация (для check)
- `--dry-run` - без изменений БД (для fix)

---

## 🔍 1. Проверка (check)

### Базовая проверка
```bash
# Все кассы
php artisan cash:balance check

# Конкретная касса
php artisan cash:balance check 1
```

### С деталями
```bash
# Все кассы с подробностями
php artisan cash:balance check --detailed

# Конкретная касса с подробностями
php artisan cash:balance check 1 --detailed
```

**Показывает:**
- ✅ Основные транзакции (`is_debt = false`) - учитываются в балансе
- 💳 Долговые операции (`is_debt = true`) - НЕ учитываются в балансе
- 💰 Сравнение рассчитанного и текущего баланса
- ⚡ Общую статистику по всем кассам

---

## 🔎 2. Анализ (analyze)

```bash
# Анализ всех касс
php artisan cash:balance analyze

# Анализ конкретной кассы
php artisan cash:balance analyze 1
```

**Показывает:**
- 🔍 Детальный анализ причин расхождения
- 💳 Влияние долговых операций
- 📋 Последние 5 долговых транзакций
- 📊 Теоретический расчет если бы долги учитывались
- 🔧 SQL для ручного исправления
- 💡 Рекомендации

**Когда использовать:**
- После обнаружения расхождений
- Чтобы понять ПОЧЕМУ возникло расхождение

---

## 🔧 3. Исправление (fix)

### Проверка (без изменений)
```bash
# Показать что будет изменено
php artisan cash:balance fix --dry-run

# Для конкретной кассы
php artisan cash:balance fix 1 --dry-run
```

### Реальное исправление
```bash
# Исправить все кассы
php artisan cash:balance fix

# Исправить конкретную кассу
php artisan cash:balance fix 1
```

⚠️ **ВНИМАНИЕ**: Изменяет данные в БД!
1. Сделайте бэкап БД
2. Проверьте через `--dry-run`
3. Подтвердите изменения

---

## 📖 Логика долгов

### Как работает:

1. **С галочкой долга** (`is_debt = true`):
   - ❌ НЕ учитывается в балансе кассы
   - ✅ Учитывается в балансе клиента
   - 💡 Для отсрочки платежа

2. **Без галочки долга** (`is_debt = false`):
   - ✅ Учитывается в балансе кассы
   - ✅ Учитывается в балансе клиента

3. **Формула**:
   ```
   Баланс кассы = Приход (is_debt=false) - Расход (is_debt=false)
   ```

### Почему возникло расхождение:

Ранее был баг при изменении флага `is_debt` - баланс кассы пересчитывался неправильно. Это привело к накопленным расхождениям.

---

## 🎯 Порядок действий

```bash
# 1. Проверка
php artisan cash:balance check --detailed

# 2. Анализ (если есть расхождения)
php artisan cash:balance analyze

# 3. Проверка исправлений
php artisan cash:balance fix --dry-run

# 4. Резервная копия
mysqldump -u user -p database > backup.sql

# 5. Исправление
php artisan cash:balance fix

# 6. Проверка результата
php artisan cash:balance check
```

---

## 💡 Примеры

### Пример вывода проверки
```
═══════════════════════════════════════════════════════════
📦 Касса: LT касса (ID: 1)
   Валюта: TMT (TMT)

   📊 ОСНОВНЫЕ ТРАНЗАКЦИИ (учитываются в балансе кассы):
      ┌─ Приход:              442 094.00 (28 транзакций)
      └─ Расход:              330 886.00 (244 транзакций)

   💳 ДОЛГОВЫЕ ОПЕРАЦИИ (НЕ учитываются в балансе кассы):
      ┌─ Приход (долг):       0.00 (0 транзакций)
      └─ Расход (долг):       80 420.00 (7 транзакций)

   💰 БАЛАНС:
      ┌─ Рассчитанный:        111 208.00
      └─ Текущий в БД:        143 403.00

   ❌ РАСХОЖДЕНИЕ: -32 195.00
```

### Пример исправления
```bash
php artisan cash:balance fix 1
```

Вывод:
```
⚠️  ВНИМАНИЕ: Баланс кассы будет ИЗМЕНЕН в БД!
Продолжить? (yes/no) [no]: yes

═══════════════════════════════════════════════════════════
📦 Касса: LT касса (ID: 1)

   📊 Транзакции (НЕ долговые):
      Приход:                442 094.00 (28 шт)
      Расход:                330 886.00 (244 шт)

   💰 Баланс:
      Текущий в БД:          143 403.00
      Правильный:            111 208.00
      Расхождение:           -32 195.00

   ✅ ИСПРАВЛЕНО:
      Было:      143 403.00
      Стало:     111 208.00
```

---

## ⚠️ Важно

- ✅ `check` и `analyze` - **НИКОГДА** не изменяют данные
- ⚠️ `fix` - **ИЗМЕНЯЕТ** баланс в БД (с подтверждением)
- 💾 Всегда делайте бэкап перед `fix`
- ✅ Безопасно для продакшена

---

## 🐛 FAQ

**Q: Баланс все еще неправильный после исправления?**
- Проверьте нет ли новых транзакций
- Убедитесь что баг в `TransactionsRepository.php` исправлен
- Проверьте логи Laravel

**Q: Расхождение слишком большое?**
- Это накопленная ошибка от множества операций
- Используйте `analyze` для деталей
- После исправления бага и `fix` всё будет ОК

