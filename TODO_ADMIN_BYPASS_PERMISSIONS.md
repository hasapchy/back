# План реализации: is_admin обходит все проверки прав

## Цель
Реализовать функционал, при котором пользователь с `is_admin = true` имеет все права доступа независимо от назначенных ролей и пермишенов.

## Принцип работы
Если у пользователя `is_admin = true`, то:
- Все проверки пермишенов возвращают `true`
- Все проверки прав на действия возвращают `true`
- Middleware пропускает все запросы
- Пользователь видит все данные и может выполнять все действия

## Этапы реализации

### 1. Обновление базового контроллера (Controller.php)
- [x] Обновить метод `hasPermission()`:
  - Добавить проверку `is_admin` в начале метода
  - Если `is_admin = true`, возвращать `true` сразу
- [x] Обновить метод `canPerformAction()`:
  - Добавить проверку `is_admin` в начале метода
  - Если `is_admin = true`, возвращать `true` сразу
- [x] Обновить метод `hasAnyPermission()`:
  - Добавить проверку `is_admin` в начале метода
  - Если `is_admin = true`, возвращать `true` сразу
- [x] Обновить метод `getUserPermissions()`:
  - Если `is_admin = true`, возвращать все существующие пермишены из системы

### 2. Обновление middleware
- [x] Обновить `PermissionWithScopeMiddleware`:
  - Добавить проверку `is_admin` в начале метода `handle()`
  - Если `is_admin = true`, сразу пропускать запрос без проверки пермишенов
- [x] Создать кастомный `PermissionMiddleware`:
  - Заменить стандартный Spatie middleware
  - Добавить проверку `is_admin`
- [x] Обновить `CheckPermission` middleware:
  - Добавить проверку `is_admin`
- [x] Обновить `EnsureSimpleWorker` middleware:
  - Добавить проверку `is_admin`
- [x] Обновить `PreventSimpleAccess` middleware:
  - Добавить проверку `is_admin`
- [x] Обновить `AuthServiceProvider`:
  - Добавить проверку `is_admin` в Gate::before

### 3. Обновление модели User
- [x] Переопределить метод `getAllPermissions()`:
  - Если `is_admin = true`, возвращать все пермишены из системы
  - Иначе возвращать пермишены из ролей (текущая логика)
- [x] Обновить метод `getAllPermissionsForCompany()`:
  - Если `is_admin = true`, возвращать все пермишены из системы
  - Иначе возвращать пермишены из ролей компании (текущая логика)

### 4. Обновление фронтенда (store/index.js)
- [x] Обновить getter `hasPermission`:
  - Добавить проверку `is_admin` из state.user
  - Если `is_admin = true`, возвращать `true` для любого пермишена

### 5. Обновление роутера (router/index.js)
- [x] Обновить проверку `isAdmin`:
  - Использовать `user.isAdmin` вместо проверки роли "admin"
  - Обновить логику для simple маршрутов

### 6. Обновление компонентов фронтенда
- [ ] Найти все места, где проверяется роль "admin" через роли
- [ ] Заменить на проверку `user.is_admin`
- [ ] Обновить компоненты, которые скрывают/показывают элементы на основе прав:
  - Если `is_admin = true`, показывать все элементы

### 7. Обновление API ответов
- [x] Убедиться, что поле `is_admin` передается в ответах API
- [x] Проверить UserDto на фронте (содержит `is_admin`)
- [x] AuthController возвращает `is_admin` в ответах login, me, refresh

### 8. Обновление документации
- [ ] Обновить документацию по правам доступа
- [ ] Указать, что `is_admin` обходит все проверки прав
- [ ] Обновить Swagger/OpenAPI документацию

### 9. Тестирование
- [ ] Протестировать все проверки прав с `is_admin = true`
- [ ] Протестировать middleware с `is_admin = true`
- [ ] Протестировать фронтенд с `is_admin = true`
- [ ] Протестировать, что обычные пользователи работают как раньше
- [ ] Протестировать переключение между компаниями для админа

### 10. Безопасность
- [x] Убедиться, что `is_admin` нельзя установить через API (только админы могут)
- [x] Проверить, что поле `is_admin` не в fillable (защищено от массового присвоения)
- [x] Добавить проверку при создании/обновлении пользователя (только админы могут устанавливать is_admin)

## Важные моменты

### Приоритет проверки
1. Сначала проверяется `is_admin`
2. Если `is_admin = false`, выполняется обычная проверка прав

### Производительность
- Проверка `is_admin` должна быть первой и быстрой
- Не нужно загружать все пермишены для админа, если достаточно просто вернуть `true`

### Обратная совместимость
- Существующие пользователи с ролью "admin" продолжат работать
- Но теперь `is_admin = true` будет иметь приоритет над ролями

### Логирование (опционально)
- Можно добавить логирование действий админа для аудита
- Отслеживать, когда админ обходит проверки прав

## Порядок выполнения
1. Сначала обновить бэкенд (п.1-3) - это критично для безопасности
2. Затем обновить middleware (п.2)
3. Потом обновить фронтенд (п.4-6)
4. Обновить API ответы (п.7)
5. Тестирование (п.9)
6. Документация (п.8)
7. Безопасность (п.10)

## Файлы для изменения

### Бэкенд:
- `app/Http/Controllers/Controller.php`
- `app/Http/Middleware/PermissionWithScopeMiddleware.php`
- `app/Models/User.php`
- `app/Http/Controllers/Api/AuthController.php` (проверить ответ /me)

### Фронтенд:
- `src/store/index.js` (getter hasPermission)
- `src/router/index.js` (проверка isAdmin)
- `src/dto/users/UserDto.js` (проверка наличия is_admin)
- Все компоненты, использующие проверку прав

