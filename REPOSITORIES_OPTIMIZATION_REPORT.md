# –û—Ç—á–µ—Ç –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### CahRegistersRepository
- ‚úÖ **–£–±—Ä–∞–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç** (~60 —Å—Ç—Ä–æ–∫)
  - –ó–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `applyDateFilter()` –∏–∑ `BaseRepository`
  - –ü—Ä–∏–º–µ–Ω–µ–Ω–æ –¥–ª—è `$transactionsQuery` –∏ `$clientCreditsQuery`
- ‚úÖ **–£–±—Ä–∞–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º** (~80 —Å—Ç—Ä–æ–∫)
  - –°–æ–∑–¥–∞–Ω –º–µ—Ç–æ–¥ `applySourceFilter()` –¥–ª—è —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ª–æ–≥–∏–∫–∏
  - –£–ø—Ä–æ—â–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —á–µ—Ä–µ–∑ `whereIn()` –∏ `orWhere()`
- ‚úÖ **–£–ø—Ä–æ—â–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `$cashRegisters->isEmpty()`**
  - –ü–µ—Ä–µ–º–µ—â–µ–Ω–∞ –≤ –±–æ–ª–µ–µ –ª–æ–≥–∏—á–Ω–æ–µ –º–µ—Å—Ç–æ

### ClientsRepository
- ‚úÖ **–£–ø—Ä–æ—â–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞**
  - –û–±—ä–µ–¥–∏–Ω–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ `$includeInactive` –∏ `$statusFilter`
- ‚úÖ **–£–ø—Ä–æ—â–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `$client->employee_id`**
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω `optional($client)->employee_id`

### CommentsRepository
- ‚úÖ **–£–ø—Ä–æ—â–µ–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏**
  - –ó–∞–º–µ–Ω–µ–Ω—ã —Ä—É—á–Ω—ã–µ `DB::beginTransaction()` –Ω–∞ `DB::transaction()`
- ‚úÖ **–£–ø—Ä–æ—â–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞**
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω `optional($currentUser)->is_admin`
- ‚úÖ **–£–ø—Ä–æ—â–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è**
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω `firstOrFail()` –≤–º–µ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ `null`

### InvoicesRepository
- ‚úÖ **–£–ø—Ä–æ—â–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ `isset()`**
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω `array_filter()` –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ **–£–ø—Ä–æ—â–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª—é—Ç—ã**
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω `optional($order->cash)->currency`

### LeaveRepository
- ‚úÖ **–£–ø—Ä–æ—â–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤**
  - –ó–∞–º–µ–Ω–µ–Ω—ã –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ `if (isset())` –Ω–∞ `when()`
  - –ü—Ä–∏–º–µ–Ω–µ–Ω–æ –≤ `getItemsWithPagination()` –∏ `getAllItems()`

### ProductsRepository
- ‚úÖ **–£–¥–∞–ª–µ–Ω–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è**
  - –£–¥–∞–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `$usedInOrders` (–≤—Å–µ–≥–¥–∞ –±—ã–ª–∞ `false`)
- ‚úÖ **–£–ø—Ä–æ—â–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `isset($data['image'])`**
  - –ó–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ `$data['image'] ?? null`

### SalesRepository
- ‚úÖ **–£–ø—Ä–æ—â–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∏—Å–∫–∞**
  - –ó–∞–º–µ–Ω–µ–Ω–æ `$search !== null` –Ω–∞ `if ($search)`

### TransactionsRepository
- ‚úÖ **–£–ø—Ä–æ—â–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `$is_debt`**
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω `filter_var()` –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –∑–Ω–∞—á–µ–Ω–∏–π
- ‚úÖ **–£–ø—Ä–æ—â–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ `!empty($data['note'])`**
  - –ó–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ `$data['note'] ?? null` (3 –º–µ—Å—Ç–∞)

### WarehouseReceiptRepository
- ‚úÖ **–£–ø—Ä–æ—â–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ `!empty($data['note'])`**
  - –ó–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ `$data['note'] ?? null` (2 –º–µ—Å—Ç–∞)

### WarehouseMovementRepository
- ‚úÖ **–£–¥–∞–ª–µ–Ω—ã –∏–∑–±—ã—Ç–æ—á–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ `$stock_updated`**
  - –£–¥–∞–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è (–º–µ—Ç–æ–¥ –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `true`)

### WarehouseWriteoffRepository
- ‚úÖ **–£–¥–∞–ª–µ–Ω—ã –∏–∑–±—ã—Ç–æ—á–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ `$stock_updated`**
  - –£–¥–∞–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è (3 –º–µ—Å—Ç–∞)

### ProjectsRepository
- ‚úÖ **–£–ø—Ä–æ—â–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `$result->creator`**
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω `optional($result)->creator`

### UsersRepository
- ‚úÖ **–£–ø—Ä–æ—â–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞**
  - –ó–∞–º–µ–Ω–µ–Ω–æ `$currentUser && !$currentUser->is_admin` –Ω–∞ `!optional($currentUser)->is_admin` (3 –º–µ—Å—Ç–∞)
- ‚úÖ **–£–ø—Ä–æ—â–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `birthday`**
  - –ó–∞–º–µ–Ω–µ–Ω–æ `isset($data['birthday']) && $data['birthday']` –Ω–∞ `!empty($data['birthday'])`

### CategoriesRepository
- ‚úÖ **–£–ø—Ä–æ—â–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `parent_id`**
  - –ó–∞–º–µ–Ω–µ–Ω–æ `($data['parent_id'] === '' || $data['parent_id'] === null)` –Ω–∞ `empty($data['parent_id'])` (2 –º–µ—Å—Ç–∞)

### OrdersRepository
- ‚úÖ **–£–ø—Ä–æ—â–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ `!empty($data['note'])`**
  - –ó–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ `$data['note'] ?? null` (2 –º–µ—Å—Ç–∞)

### CahRegistersRepository (updateItem)
- ‚úÖ **–£–ø—Ä–æ—â–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ `isset()`**
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω `array_filter()` –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π

- **–£–¥–∞–ª–µ–Ω–æ —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞:** ~200
- **–£–ø—Ä–æ—â–µ–Ω–æ –ø—Ä–æ–≤–µ—Ä–æ–∫:** ~30
- **–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ:** 14
- **–°–æ–∑–¥–∞–Ω–æ –Ω–æ–≤—ã—Ö –º–µ—Ç–æ–¥–æ–≤:** 1 (`applySourceFilter` –≤ `CahRegistersRepository`)

---

## –û–±—â–∏–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### 1. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –¥–∞—Ç–∞–º
**–ü—Ä–æ–±–ª–µ–º–∞:** –í `CahRegistersRepository::getCashBalance()` –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –ª–æ–≥–∏–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç (—Å—Ç—Ä–æ–∫–∏ 94-123 –∏ 217-245). –¢–∞ –∂–µ –ª–æ–≥–∏–∫–∞ –µ—Å—Ç—å –≤ `BaseRepository::applyDateFilter()`.

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `applyDateFilter()` –∏–∑ –±–∞–∑–æ–≤–æ–≥–æ –∫–ª–∞—Å—Å–∞.

### 2. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
**–ü—Ä–æ–±–ª–µ–º–∞:** –í `CahRegistersRepository::getCashBalance()` –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –ª–æ–≥–∏–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ `source` (—Å—Ç—Ä–æ–∫–∏ 141-199 –∏ 262-320). –¢–∞ –∂–µ –ª–æ–≥–∏–∫–∞ –µ—Å—Ç—å –≤ `TransactionsRepository::applySourceTypeFilter()`.

**–†–µ—à–µ–Ω–∏–µ:** –í—ã–Ω–µ—Å—Ç–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π.

---

## CahRegistersRepository

### ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ:

1. ‚úÖ **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç** - –ò–°–ü–†–ê–í–õ–ï–ù–û
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `applyDateFilter()` –∏–∑ `BaseRepository`
   - –£–¥–∞–ª–µ–Ω–æ ~60 —Å—Ç—Ä–æ–∫ –¥—É–±–ª–∏—Ä—É—é—â–µ–≥–æ—Å—è –∫–æ–¥–∞

2. ‚úÖ **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º** - –ò–°–ü–†–ê–í–õ–ï–ù–û
   - –°–æ–∑–¥–∞–Ω –º–µ—Ç–æ–¥ `applySourceFilter()` –¥–ª—è —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ª–æ–≥–∏–∫–∏
   - –£–¥–∞–ª–µ–Ω–æ ~80 —Å—Ç—Ä–æ–∫ –¥—É–±–ª–∏—Ä—É—é—â–µ–≥–æ—Å—è –∫–æ–¥–∞

3. ‚úÖ **–ò–∑–±—ã—Ç–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ `$cashRegisters->isEmpty()`** - –ò–°–ü–†–ê–í–õ–ï–ù–û
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞ –≤ –±–æ–ª–µ–µ –ª–æ–≥–∏—á–Ω–æ–µ –º–µ—Å—Ç–æ

### –û—Å—Ç–∞–ª–æ—Å—å:

4. **–ò–∑–±—ã—Ç–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ `empty($cash_register_ids)`** (—Å—Ç—Ä–æ–∫–∞ 80)
   - –ú–æ–∂–Ω–æ —É–ø—Ä–æ—Å—Ç–∏—Ç—å —É—Å–ª–æ–≤–∏–µ: `if (!$all && !empty($cash_register_ids))`

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

```php
// –í–º–µ—Å—Ç–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç:
if ($startDate && $endDate) {
    try {
        $parsedStart = \Carbon\Carbon::createFromFormat('d.m.Y', $startDate)->startOfDay();
        // ...
    } catch (\Exception $e) {
        // ...
    }
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
$this->applyDateFilter($query, 'custom', $startDate, $endDate, 'date');
```

---

## CategoriesRepository

### ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ:

1. ‚úÖ **–ò–∑–±—ã—Ç–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ `$data['parent_id'] === ''`** - –ò–°–ü–†–ê–í–õ–ï–ù–û
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `empty($data['parent_id'])` (2 –º–µ—Å—Ç–∞)

2. ‚úÖ **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º** - –ò–°–ü–†–ê–í–õ–ï–ù–û
   - –°–æ–∑–¥–∞–Ω –º–µ—Ç–æ–¥ `applyUserFilter()` –¥–ª—è —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ª–æ–≥–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (3 –º–µ—Å—Ç–∞)

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

```php
// –í—ã–Ω–µ—Å—Ç–∏ –≤ –º–µ—Ç–æ–¥:
private function applyCategoryUserFilter($query, $userUuid) {
    if ($this->shouldApplyUserFilter('categories')) {
        $query->join('category_users', 'categories.id', '=', 'category_users.category_id')
            ->where('category_users.user_id', $userUuid)
            ->distinct();
    }
    return $query;
}
```

---

## ClientsRepository

### ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ:

1. ‚úÖ **–ò–∑–±—ã—Ç–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ `$statusFilter !== null && $statusFilter !== ''`** - –ò–°–ü–†–ê–í–õ–ï–ù–û
   - –û–±—ä–µ–¥–∏–Ω–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ `$includeInactive` –∏ `$statusFilter`

2. ‚úÖ **–ò–∑–±—ã—Ç–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ `$client && $client->employee_id`** - –ò–°–ü–†–ê–í–õ–ï–ù–û
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω `optional($client)->employee_id`

### –û—Å—Ç–∞–ª–æ—Å—å:

1. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –ø–æ–∏—Å–∫–∞** (—Å—Ç—Ä–æ–∫–∏ 70-85, 225-240)
   - –ü–æ—Ö–æ–∂–∞—è –ª–æ–≥–∏–∫–∞ –≤ `getItemsWithPagination()` –∏ `searchClient()`
   - –ú–æ–∂–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥

2. **–°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤ `getBalanceHistory()`** (—Å—Ç—Ä–æ–∫–∏ 460-597)
   - –ú–Ω–æ–≥–æ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π, –º–æ–∂–Ω–æ —Ä–∞–∑–±–∏—Ç—å –Ω–∞ –º–µ—Ç–æ–¥—ã

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

```php
// –£–ø—Ä–æ—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞:
if ($statusFilter) {
    $query->where('clients.status', $statusFilter === 'active');
}

// –í—ã–Ω–µ—Å—Ç–∏ –ø–æ–∏—Å–∫ –≤ –º–µ—Ç–æ–¥:
private function applyClientSearch($query, $search) {
    $searchTerm = "%{$search}%";
    $searchLower = mb_strtolower($search);
    // ... –ª–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞
}
```

---

## CommentsRepository

### ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ:

1. ‚úÖ **–ò–∑–±—ã—Ç–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ `$currentUser || !$currentUser->is_admin`** - –ò–°–ü–†–ê–í–õ–ï–ù–û
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω `optional($currentUser)->is_admin`

2. ‚úÖ **–†—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏** - –ò–°–ü–†–ê–í–õ–ï–ù–û
   - –ó–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ `DB::transaction()` –≤ `updateItem()` –∏ `deleteItem()`
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω `firstOrFail()` –≤–º–µ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ `null`

3. ‚úÖ **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞** - –ò–°–ü–†–ê–í–õ–ï–ù–û
   - –°–æ–∑–¥–∞–Ω –º–µ—Ç–æ–¥ `applyUserAccessFilter()` –¥–ª—è —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

```php
// –í—ã–Ω–µ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∞–≤:
private function canEditComment($commentId, $userId): bool {
    $currentUser = auth('api')->user();
    if ($currentUser && $currentUser->is_admin) {
        return true;
    }
    return Comment::where('id', $commentId)
        ->where('user_id', $userId)
        ->exists();
}
```

---

## InvoicesRepository

### ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ:

1. ‚úÖ **–ò–∑–±—ã—Ç–æ—á–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ `isset()`** - –ò–°–ü–†–ê–í–õ–ï–ù–û
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω `array_filter()` –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö

2. ‚úÖ **–ò–∑–±—ã—Ç–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ `$orders`** - –ò–°–ü–†–ê–í–õ–ï–ù–û
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω `optional($order->cash)->currency`

3. ‚úÖ **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤** - –ò–°–ü–†–ê–í–õ–ï–ù–û
   - –°–æ–∑–¥–∞–Ω –º–µ—Ç–æ–¥ `prepareProductsData()` –¥–ª—è —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ª–æ–≥–∏–∫–∏ (2 –º–µ—Å—Ç–∞)

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

```php
// –í—ã–Ω–µ—Å—Ç–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É –ø—Ä–æ–¥—É–∫—Ç–æ–≤:
private function prepareProductsData(array $products, int $invoiceId): array {
    return collect($products)->map(function ($product) use ($invoiceId) {
        $quantity = (float) ($product['quantity'] ?? 0);
        $price = (float) ($product['price'] ?? 0);
        return [
            'invoice_id' => $invoiceId,
            'order_id' => $product['order_id'] ?? null,
            'product_id' => $product['product_id'] ?? null,
            'product_name' => $product['product_name'],
            'product_description' => $product['product_description'] ?? null,
            'quantity' => $quantity,
            'price' => $price,
            'total_price' => $product['total_price'] ?? ($quantity * $price),
            'unit_id' => $product['unit_id'] ?? null,
        ];
    })->toArray();
}
```

---

## LeaveRepository

### ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ:

1. ‚úÖ **–ò–∑–±—ã—Ç–æ—á–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ `isset()`** - –ò–°–ü–†–ê–í–õ–ï–ù–û
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω `when()` –∏–∑ Laravel –≤ –æ–±–æ–∏—Ö –º–µ—Ç–æ–¥–∞—Ö

2. ‚úÖ **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏** - –ò–°–ü–†–ê–í–õ–ï–ù–û
   - –°–æ–∑–¥–∞–Ω –º–µ—Ç–æ–¥ `applyFilters()` –¥–ª—è —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ª–æ–≥–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

```php
// –£–ø—Ä–æ—Å—Ç–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é:
private function applyFilters($query, $filters) {
    return $query
        ->when(isset($filters['user_id']), fn($q) => $q->where('user_id', $filters['user_id']))
        ->when(isset($filters['leave_type_id']), fn($q) => $q->where('leave_type_id', $filters['leave_type_id']))
        ->when(isset($filters['date_from']), fn($q) => $q->where('date_from', '>=', $filters['date_from']))
        ->when(isset($filters['date_to']), fn($q) => $q->where('date_to', '<=', $filters['date_to']));
}
```

---

## OrdersRepository

### –ü—Ä–æ–±–ª–µ–º—ã:

1. **–û—á–µ–Ω—å –±–æ–ª—å—à–æ–π –º–µ—Ç–æ–¥ `getItemsWithPagination()`** (—Å—Ç—Ä–æ–∫–∏ 43-337)
   - –†–∞–∑–±–∏—Ç—å –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Ç–æ–¥–æ–≤

2. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –∫–∞—Å—Å–∞–º** (—Å—Ç—Ä–æ–∫–∏ 86-97, 294-305)
   - –í—ã–Ω–µ—Å—Ç–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥

3. **–ò–∑–±—ã—Ç–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ `$loadProducts`** (—Å—Ç—Ä–æ–∫–∞ 52, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
   - –£–¥–∞–ª–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é

4. **–°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤** (—Å—Ç—Ä–æ–∫–∏ 806-890)
   - –†–∞–∑–±–∏—Ç—å –Ω–∞ –º–µ—Ç–æ–¥—ã

5. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–Ω** (—Å—Ç—Ä–æ–∫–∏ 574, 756)
   - –í—ã–Ω–µ—Å—Ç–∏ –≤ –º–µ—Ç–æ–¥

6. **–ò–∑–±—ã—Ç–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ `$hasChanges && !$productsChanged`** (—Å—Ç—Ä–æ–∫–∞ 968)
   - –ú–æ–∂–Ω–æ —É–ø—Ä–æ—Å—Ç–∏—Ç—å

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

```php
// –í—ã–Ω–µ—Å—Ç–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ –∫–∞—Å—Å–∞–º:
private function applyCashRegisterFilter($query, $userUuid) {
    if ($this->shouldApplyUserFilter('cash_registers')) {
        $query->where(function ($q) use ($userUuid) {
            $q->whereNull('orders.cash_id');
            $filterUserId = $this->getFilterUserIdForPermission('cash_registers', $userUuid);
            $q->orWhereExists(function ($subQuery) use ($filterUserId) {
                $subQuery->select(DB::raw(1))
                    ->from('cash_register_users')
                    ->whereColumn('cash_register_users.cash_register_id', 'orders.cash_id')
                    ->where('cash_register_users.user_id', $filterUserId);
            });
        });
    }
    return $query;
}
```

---

## ProductsRepository

### ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ:

1. ‚úÖ **–ò–∑–±—ã—Ç–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ `isset($data['image'])`** - –ò–°–ü–†–ê–í–õ–ï–ù–û
   - –ó–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ `$data['image'] ?? null` –≤ `createItem()`
   - –í `updateItem()` –æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `array_key_exists()` –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã

2. ‚úÖ **–ò–∑–±—ã—Ç–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ `$usedInOrders`** - –ò–°–ü–†–ê–í–õ–ï–ù–û
   - –£–¥–∞–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è, –≤—Å–µ–≥–¥–∞ –±—ã–ª–∞ `false`

### –û—Å—Ç–∞–ª–æ—Å—å:

1. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤** (—Å—Ç—Ä–æ–∫–∏ 84-115, 182-213)
   - –í—ã–Ω–µ—Å—Ç–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥

2. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –æ–±–æ–≥–∞—â–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞** (—Å—Ç—Ä–æ–∫–∏ 117-126, 215-224)
   - –í—ã–Ω–µ—Å—Ç–∏ –≤ –º–µ—Ç–æ–¥

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

```php
// –í—ã–Ω–µ—Å—Ç–∏ –ø–æ–ª—É—á–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤:
private function getStocksMap($productIds, $warehouseId, $userUuid): array {
    if ($productIds->isEmpty()) {
        return [];
    }
    
    $warehouseIds = [];
    if (!$warehouseId && $this->shouldApplyUserFilter('warehouses')) {
        $warehouseIds = WhUser::where('user_id', $userUuid)
            ->pluck('warehouse_id')
            ->toArray();
    }
    
    if ($warehouseId) {
        return WarehouseStock::where('warehouse_id', $warehouseId)
            ->whereIn('product_id', $productIds)
            ->pluck('quantity', 'product_id')
            ->toArray();
    }
    
    if (empty($warehouseIds)) {
        return WarehouseStock::whereIn('product_id', $productIds)
            ->select('product_id', DB::raw('SUM(quantity) as total'))
            ->groupBy('product_id')
            ->pluck('total', 'product_id')
            ->toArray();
    }
    
    return WarehouseStock::whereIn('warehouse_id', $warehouseIds)
        ->whereIn('product_id', $productIds)
        ->select('product_id', DB::raw('SUM(quantity) as total'))
        ->groupBy('product_id')
        ->pluck('total', 'product_id')
        ->toArray();
}
```

---

## ProjectsRepository

### ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ:

1. ‚úÖ **–ò–∑–±—ã—Ç–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ `$result && $result->creator`** - –ò–°–ü–†–ê–í–õ–ï–ù–û
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω `optional($result)->creator`

### –û—Å—Ç–∞–ª–æ—Å—å:

1. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏** (—Å—Ç—Ä–æ–∫–∏ 117-123, 158-164)
   - –í—ã–Ω–µ—Å—Ç–∏ –≤ –º–µ—Ç–æ–¥

2. **–°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤ `getBalanceHistory()`** (—Å—Ç—Ä–æ–∫–∏ 325-431)
   - –†–∞–∑–±–∏—Ç—å –Ω–∞ –º–µ—Ç–æ–¥—ã

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

```php
// –í—ã–Ω–µ—Å—Ç–∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—é:
private function transformProject($project) {
    if ($project->creator) {
        $project->user_name = $project->creator->name;
        $project->user_photo = $project->creator->photo;
    }
    return $project;
}
```

---

## SalesRepository

### ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ:

1. ‚úÖ **–ò–∑–±—ã—Ç–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ `$search !== null`** - –ò–°–ü–†–ê–í–õ–ï–ù–û
   - –ó–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ `if ($search)`

### –û—Å—Ç–∞–ª–æ—Å—å:

1. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π** (—Å—Ç—Ä–æ–∫–∏ 247-262, 264-294)
   - –õ–æ–≥–∏–∫–∞ –æ—á–µ–Ω—å –ø–æ—Ö–æ–∂–∞, –º–æ–∂–Ω–æ —É–ø—Ä–æ—Å—Ç–∏—Ç—å

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

```php
// –£–ø—Ä–æ—Å—Ç–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:
$transactionData = [
    'client_id' => $clientId,
    'amount' => $totalPrice,
    'orig_amount' => $totalPrice,
    'type' => 1,
    'is_debt' => $isDebt,
    'cash_id' => $cashId,
    'category_id' => 1,
    'date' => $date,
    'note' => $note,
    'user_id' => $userId,
    'project_id' => $projectId,
    'currency_id' => $defaultCurrency->id,
];

$this->createTransactionForSource($transactionData, Sale::class, $sale->id, true);

if (!$isDebt) {
    $transactionData['is_debt'] = false;
    $this->createTransactionForSource($transactionData, Sale::class, $sale->id, true);
}
```

---

## TransactionsRepository

### ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ:

1. ‚úÖ **–ò–∑–±—ã—Ç–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ `$is_debt !== null`** - –ò–°–ü–†–ê–í–õ–ï–ù–û
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω `filter_var()` –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –∑–Ω–∞—á–µ–Ω–∏–π

2. ‚úÖ **–£–ø—Ä–æ—â–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ `!empty($data['note'])`** - –ò–°–ü–†–ê–í–õ–ï–ù–û
   - –ó–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ `$data['note'] ?? null` (3 –º–µ—Å—Ç–∞)

### –û—Å—Ç–∞–ª–æ—Å—å:

1. **–û—á–µ–Ω—å –±–æ–ª—å—à–æ–π –º–µ—Ç–æ–¥ `getItemsWithPagination()`** (—Å—Ç—Ä–æ–∫–∏ 47-321)
   - –†–∞–∑–±–∏—Ç—å –Ω–∞ –º–µ—Ç–æ–¥—ã

2. **–°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤–∞–ª—é—Ç** (—Å—Ç—Ä–æ–∫–∏ 334-503, 575-801)
   - –í—ã–Ω–µ—Å—Ç–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥

3. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –∫–∞—Å—Å—ã** (—Å—Ç—Ä–æ–∫–∏ 424-432, 595-603, 682-690, 837-845)
   - –í—ã–Ω–µ—Å—Ç–∏ –≤ –º–µ—Ç–æ–¥

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

```php
// –í—ã–Ω–µ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –∫–∞—Å—Å—ã:
private function updateCashRegisterBalance($cashRegisterId, $amount, $type, $isDebt) {
    if ($isDebt) {
        return;
    }
    
    $operation = $type === 1 ? '+' : '-';
    DB::table('cash_registers')
        ->where('id', $cashRegisterId)
        ->update(['balance' => DB::raw("balance {$operation} " . ($amount + 0))]);
}
```

---

## UsersRepository

### ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ:

1. ‚úÖ **–ò–∑–±—ã—Ç–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ `$currentUser && !$currentUser->is_admin`** - –ò–°–ü–†–ê–í–õ–ï–ù–û
   - –ó–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ `!optional($currentUser)->is_admin` (3 –º–µ—Å—Ç–∞)

2. ‚úÖ **–£–ø—Ä–æ—â–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `birthday`** - –ò–°–ü–†–ê–í–õ–ï–ù–û
   - –ó–∞–º–µ–Ω–µ–Ω–æ `isset($data['birthday']) && $data['birthday']` –Ω–∞ `!empty($data['birthday'])`

### –û—Å—Ç–∞–ª–æ—Å—å:

1. **–û—á–µ–Ω—å –±–æ–ª—å—à–æ–π –º–µ—Ç–æ–¥ `getItemsWithPagination()`** (—Å—Ç—Ä–æ–∫–∏ 44-126)
   - –†–∞–∑–±–∏—Ç—å –Ω–∞ –º–µ—Ç–æ–¥—ã

2. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –∫–æ–º–ø–∞–Ω–∏—è–º** (—Å—Ç—Ä–æ–∫–∏ 72-76, 191-195, 932-936)
   - –í—ã–Ω–µ—Å—Ç–∏ –≤ –º–µ—Ç–æ–¥

3. **–°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö** (—Å—Ç—Ä–æ–∫–∏ 623-656)
   - –ú–æ–∂–Ω–æ —É–ø—Ä–æ—Å—Ç–∏—Ç—å —á–µ—Ä–µ–∑ –º–∞—Å—Å–∏–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

```php
// –£–ø—Ä–æ—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:
private function checkUserRelatedData(User $user): array {
    $checks = [
        [Transaction::class, 'user_id', '—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏'],
        [Order::class, 'user_id', '–∑–∞–∫–∞–∑—ã'],
        // ...
    ];
    
    return collect($checks)
        ->filter(fn($check) => $check[0]::where($check[1], $user->id)->exists())
        ->map(fn($check) => "{$check[2]} ({$check[0]::where($check[1], $user->id)->count()})")
        ->toArray();
}
```

---

## WarehouseReceiptRepository

### ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ:

1. ‚úÖ **–ò–∑–±—ã—Ç–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ `!empty($data['note'])`** - –ò–°–ü–†–ê–í–õ–ï–ù–û
   - –ó–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ `$data['note'] ?? null` (2 –º–µ—Å—Ç–∞)

### –û—Å—Ç–∞–ª–æ—Å—å:

1. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π** (—Å—Ç—Ä–æ–∫–∏ 196-203)
   - –õ–æ–≥–∏–∫–∞ –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è –¥–ª—è –æ–±–æ–∏—Ö —Å–ª—É—á–∞–µ–≤

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

```php
// –£–ø—Ä–æ—Å—Ç–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:
$transactionData = [
    'type' => 0,
    'user_id' => auth('api')->id(),
    'amount' => $total_amount,
    'orig_amount' => $total_amount,
    'currency_id' => $currency->id,
    'cash_id' => $cash_id,
    'category_id' => 6,
    'project_id' => $data['project_id'] ?? null,
    'client_id' => $client_id,
    'note' => $note,
    'date' => $date,
    'is_debt' => true,
];

$this->createTransactionForSource($transactionData, WhReceipt::class, $receipt->id, true);

if ($type !== 'balance') {
    $transactionData['is_debt'] = false;
    $this->createTransactionForSource($transactionData, WhReceipt::class, $receipt->id, true);
}
```

---

## WarehouseMovementRepository

### ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ:

1. ‚úÖ **–ò–∑–±—ã—Ç–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ `$stock_updated_from && !$stock_updated_to`** - –ò–°–ü–†–ê–í–õ–ï–ù–û
   - –£–¥–∞–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è (–º–µ—Ç–æ–¥ –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `true`)

2. ‚úÖ **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤** - –ò–°–ü–†–ê–í–õ–ï–ù–û
   - –°–æ–∑–¥–∞–Ω –º–µ—Ç–æ–¥ `updateStocksForMovement()` –¥–ª—è —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ª–æ–≥–∏–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤ (3 –º–µ—Å—Ç–∞)

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

```php
// –£–ø—Ä–æ—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É:
$this->updateStock($warehouse_from_id, $product_id, -$quantity);
$this->updateStock($warehouse_to_id, $product_id, $quantity);
// –£–±—Ä–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É, —Ç–∞–∫ –∫–∞–∫ –º–µ—Ç–æ–¥ –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç true
```

---

## WarehouseWriteoffRepository

### ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ:

1. ‚úÖ **–ò–∑–±—ã—Ç–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ `$stock_updated`** - –ò–°–ü–†–ê–í–õ–ï–ù–û
   - –£–¥–∞–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è (3 –º–µ—Å—Ç–∞)

### –û—Å—Ç–∞–ª–æ—Å—å:

1. **–°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ —Å–º–µ–Ω–µ —Å–∫–ª–∞–¥–∞** (—Å—Ç—Ä–æ–∫–∏ 135-139)
   - –ú–æ–∂–Ω–æ —É–ø—Ä–æ—Å—Ç–∏—Ç—å

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

```php
// –£–ø—Ä–æ—Å—Ç–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ —Å–º–µ–Ω–µ —Å–∫–ª–∞–¥–∞:
if ($old_warehouse_id != $warehouse_id) {
    foreach ($existingProducts as $existingProduct) {
        $this->updateStock($old_warehouse_id, $existingProduct->product_id, $existingProduct->quantity);
        $this->updateStock($warehouse_id, $existingProduct->product_id, -$existingProduct->quantity);
    }
}
```

---

## –ò—Ç–æ–≥–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### ‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–ö—Ä–∏—Ç–∏—á–Ω–æ) - –í–´–ü–û–õ–ù–ï–ù–û:
1. ‚úÖ –£–±—Ä–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç –≤ `CahRegistersRepository` - **–í–´–ü–û–õ–ù–ï–ù–û**
2. ‚úÖ –£–±—Ä–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º –≤ `CahRegistersRepository` - **–í–´–ü–û–õ–ù–ï–ù–û**
3. ‚è≥ –†–∞–∑–±–∏—Ç—å –±–æ–ª—å—à–∏–µ –º–µ—Ç–æ–¥—ã –≤ `OrdersRepository`, `TransactionsRepository`, `UsersRepository` - **–û–°–¢–ê–õ–û–°–¨**

### ‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (–í–∞–∂–Ω–æ) - –ß–ê–°–¢–ò–ß–ù–û –í–´–ü–û–õ–ù–ï–ù–û:
1. ‚úÖ –£–ø—Ä–æ—Å—Ç–∏—Ç—å –∏–∑–±—ã—Ç–æ—á–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ - **–í–´–ü–û–õ–ù–ï–ù–û** (~30 –ø—Ä–æ–≤–µ—Ä–æ–∫)
2. ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `optional()` –∏ `when()` –∏–∑ Laravel - **–í–´–ü–û–õ–ù–ï–ù–û** (–º–Ω–æ–∂–µ—Å—Ç–≤–æ –º–µ—Å—Ç)
3. ‚è≥ –í—ã–Ω–µ—Å—Ç–∏ –¥—É–±–ª–∏—Ä—É—é—â—É—é—Å—è –ª–æ–≥–∏–∫—É –≤ –º–µ—Ç–æ–¥—ã –±–∞–∑–æ–≤–æ–≥–æ –∫–ª–∞—Å—Å–∞ - **–û–°–¢–ê–õ–û–°–¨** (—á–∞—Å—Ç–∏—á–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ)

### ‚è≥ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (–ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ) - –û–°–¢–ê–õ–û–°–¨:
1. ‚è≥ –£–ª—É—á—à–∏—Ç—å —á–∏—Ç–∞–µ–º–æ—Å—Ç—å –∫–æ–¥–∞ (—Ä–∞–∑–±–∏—Ç—å –±–æ–ª—å—à–∏–µ –º–µ—Ç–æ–¥—ã)
2. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å PHPDoc –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
3. ‚è≥ –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∏–ª—å –∫–æ–¥–∞

---

## üìã –ß—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å —Å–¥–µ–ª–∞—Ç—å

### –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –∑–∞–¥–∞—á–∏:

1. **OrdersRepository**
   - –†–∞–∑–±–∏—Ç—å –º–µ—Ç–æ–¥ `getItemsWithPagination()` (300+ —Å—Ç—Ä–æ–∫) –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Ç–æ–¥–æ–≤
   - –í—ã–Ω–µ—Å—Ç–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –∫–∞—Å—Å–∞–º
   - –†–∞–∑–±–∏—Ç—å —Å–ª–æ–∂–Ω—É—é –ª–æ–≥–∏–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –Ω–∞ –º–µ—Ç–æ–¥—ã
   - –í—ã–Ω–µ—Å—Ç–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–Ω

2. **TransactionsRepository**
   - –†–∞–∑–±–∏—Ç—å –º–µ—Ç–æ–¥ `getItemsWithPagination()` (270+ —Å—Ç—Ä–æ–∫) –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Ç–æ–¥–æ–≤
   - –í—ã–Ω–µ—Å—Ç–∏ —Å–ª–æ–∂–Ω—É—é –ª–æ–≥–∏–∫—É –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤–∞–ª—é—Ç –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥
   - –í—ã–Ω–µ—Å—Ç–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –∫–∞—Å—Å—ã –≤ –º–µ—Ç–æ–¥

3. **UsersRepository**
   - –†–∞–∑–±–∏—Ç—å –º–µ—Ç–æ–¥ `getItemsWithPagination()` –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Ç–æ–¥–æ–≤
   - –í—ã–Ω–µ—Å—Ç–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –∫–æ–º–ø–∞–Ω–∏—è–º
   - –£–ø—Ä–æ—Å—Ç–∏—Ç—å –ª–æ–≥–∏–∫—É –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –º–∞—Å—Å–∏–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### –í–∞–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏:

4. **ClientsRepository**
   - –í—ã–Ω–µ—Å—Ç–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –ø–æ–∏—Å–∫–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥
   - –†–∞–∑–±–∏—Ç—å —Å–ª–æ–∂–Ω—É—é –ª–æ–≥–∏–∫—É –≤ `getBalanceHistory()` –Ω–∞ –º–µ—Ç–æ–¥—ã

5. ‚úÖ **ProductsRepository** - –í–´–ü–û–õ–ù–ï–ù–û
   - ‚úÖ –í—ã–Ω–µ—Å–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤ –≤ –º–µ—Ç–æ–¥ `getStocksMap()` (2 –º–µ—Å—Ç–∞)
   - ‚úÖ –í—ã–Ω–µ—Å–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –æ–±–æ–≥–∞—â–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞ –≤ –º–µ—Ç–æ–¥ `enrichProduct()` (2 –º–µ—Å—Ç–∞)

6. **ProjectsRepository**
   - ‚úÖ –í—ã–Ω–µ—Å–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –º–µ—Ç–æ–¥ `transformProject()` - –í–´–ü–û–õ–ù–ï–ù–û
   - ‚è≥ –†–∞–∑–±–∏—Ç—å —Å–ª–æ–∂–Ω—É—é –ª–æ–≥–∏–∫—É –≤ `getBalanceHistory()` –Ω–∞ –º–µ—Ç–æ–¥—ã - –û–°–¢–ê–õ–û–°–¨

7. ‚úÖ **SalesRepository** - –í–´–ü–û–õ–ù–ï–ù–û
   - ‚úÖ –£–ø—Ä–æ—â–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π - —Å–æ–∑–¥–∞–Ω –º–µ—Ç–æ–¥ `buildSaleTransactionData()`

8. ‚úÖ **WarehouseReceiptRepository** - –í–´–ü–û–õ–ù–ï–ù–û
   - ‚úÖ –£–ø—Ä–æ—â–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π - —Å–æ–∑–¥–∞–Ω –º–µ—Ç–æ–¥ `buildReceiptTransactionData()`

9. **CategoriesRepository**
   - –í—ã–Ω–µ—Å—Ç–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –≤ –º–µ—Ç–æ–¥

10. ‚úÖ **LeaveRepository** - –í–´–ü–û–õ–ù–ï–ù–û
    - ‚úÖ –í—ã–Ω–µ—Å–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≤ –º–µ—Ç–æ–¥

11. ‚úÖ **CommentsRepository** - –í–´–ü–û–õ–ù–ï–ù–û
    - ‚úÖ –í—ã–Ω–µ—Å–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –≤ –º–µ—Ç–æ–¥

12. ‚úÖ **InvoicesRepository** - –í–´–ü–û–õ–ù–ï–ù–û
    - ‚úÖ –í—ã–Ω–µ—Å–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤ –º–µ—Ç–æ–¥

---

## –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- **–í—Å–µ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤:** 28
- **–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ —Å –ø—Ä–æ–±–ª–µ–º–∞–º–∏:** 20
- **–û—Å–Ω–æ–≤–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º:**
  - –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞: 15 —Å–ª—É—á–∞–µ–≤
  - –ò–∑–±—ã—Ç–æ—á–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏: 12 —Å–ª—É—á–∞–µ–≤
  - –°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–µ –º–µ—Ç–æ–¥—ã: 5 —Å–ª—É—á–∞–µ–≤
  - –°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞: 8 —Å–ª—É—á–∞–µ–≤

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤:** 23
- **–£–¥–∞–ª–µ–Ω–æ —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞:** ~400
- **–£–ø—Ä–æ—â–µ–Ω–æ –ø—Ä–æ–≤–µ—Ä–æ–∫:** ~30
- **–°–æ–∑–¥–∞–Ω–æ –Ω–æ–≤—ã—Ö –º–µ—Ç–æ–¥–æ–≤:** 12
- **–û—Å—Ç–∞–ª–æ—Å—å –∑–∞–¥–∞—á:**
  - –†–∞–∑–±–∏—Ç—å –±–æ–ª—å—à–∏–µ –º–µ—Ç–æ–¥—ã: 3 —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–∫—Ä–∏—Ç–∏—á–Ω–æ)
  - –£–ø—Ä–æ—Å—Ç–∏—Ç—å —Å–ª–æ–∂–Ω—É—é –ª–æ–≥–∏–∫—É: 2 —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (ClientsRepository, ProjectsRepository)

---

*–û—Ç—á–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω: 2024-12-19*
*–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è: –í—ã–Ω–µ—Å–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –≤ –º–µ—Ç–æ–¥—ã (ProductsRepository - getStocksMap, enrichProduct), —É–ø—Ä–æ—â–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –≤ WarehouseWriteoffRepository*

