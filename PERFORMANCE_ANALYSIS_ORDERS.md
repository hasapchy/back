# Анализ производительности загрузки заказов

## Найденные проблемы:

### 1. Дублирование данных в JSON ответе
- Поле `products` - упрощенный формат для компонента поиска
- Поле `order_products` - полный формат с вложенными объектами
- Оба поля содержат одни и те же данные о продуктах, увеличивая размер ответа в 2 раза

### 2. Неэффективные циклы (ИСПРАВЛЕНО)
- В методе `enrichOrderData` использовались циклы `foreach` вместо `map()`
- Оптимизировано: теперь используется `map()` и `merge()` для более эффективной работы

### 3. Подзапрос в фильтре unpaidOnly
- Подзапрос выполняется для каждого заказа в пагинации
- Может быть медленным при большом количестве заказов

### 4. Большой размер JSON ответа
- В ответе присутствуют все связи (client, user, status, warehouse, cash, project, category)
- Полная структура order_products с вложенными product и unit объектами
- Для 20 заказов с продуктами размер может достигать нескольких мегабайт

## Рекомендации по оптимизации:

### 1. Оптимизация запросов к БД
- Проверить наличие индексов на:
  - `orders.created_at` (для сортировки)
  - `transactions.source_type, source_id` (для фильтра unpaidOnly)
  - `orders.client_id`, `orders.status_id`, `orders.project_id` (для фильтров)

### 2. Уменьшение размера ответа
- Рассмотреть возможность не загружать `order_products` через eager loading, если они уже есть в `products`
- Или наоборот: загружать только `order_products` и не создавать `products`
- Использовать параметр запроса для выбора формата ответа (полный/упрощенный)

### 3. Оптимизация подзапроса unpaidOnly
- Можно загрузить суммы оплат одним запросом через `getPaidAmountsMap()` и фильтровать в PHP
- Или использовать JOIN вместо подзапроса (но нужно быть осторожным с дублированием)

### 4. Кэширование
- Проверить работу кэша - возможно кэш не работает или инвалидируется слишком часто
- Увеличить TTL кэша для заказов, если данные не критичны

### 5. Пагинация
- Проверить, какой `per_page` используется на фронтенде
- Рекомендуется не загружать больше 20-30 заказов за раз
- Если `per_page > 50`, продукты не загружаются вообще (`$loadProducts = $perPage <= 50`)

## Выполненные оптимизации:

1. ✅ Оптимизирован метод `enrichOrderData` - используется `map()` вместо циклов
2. ✅ Добавлен `makeHidden` для скрытия дублирующихся данных (но нужно проверить, не сломает ли это фронтенд)

## Следующие шаги:

1. Проверить размер ответа в реальных условиях
2. Добавить индексы в БД если их нет
3. Рассмотреть возможность разделения endpoint'ов для списка (без продуктов) и детального просмотра (с продуктами)
4. Настроить профилирование запросов для выявления узких мест

